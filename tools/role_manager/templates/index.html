<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Role Manager v2</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
</head>

<body>
    <div class="container">
        <header>
            <h1>üõ†Ô∏è Qu·∫£n L√Ω Role (Ph√¢n M·ª•c)</h1>
            <div class="controls">
                <button id="add-category-btn" class="btn btn-secondary">‚ûï Th√™m Ph√¢n M·ª•c</button>
                <button id="save-btn" class="btn btn-primary" disabled>üíæ L∆∞u C·∫•u Tr√∫c</button>
                <button id="refresh-btn" class="btn btn-secondary">üîÑ L√†m M·ªõi</button>
            </div>
            <p id="status-msg"></p>
        </header>

        <div id="loading" class="loading">ƒêang t·∫£i c·∫•u tr√∫c role...</div>

        <!-- Main Container for Categories -->
        <div id="category-container" class="category-list">
            <!-- Categories will be injected here -->
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h3>Ch·ªânh s·ª≠a Role</h3>
            <label>T√™n Role:</label>
            <input type="text" id="edit-name" />
            <label>M√†u (Decimal):</label>
            <div class="color-picker-wrapper">
                <input type="color" id="edit-color-picker">
                <input type="number" id="edit-color-decimal" placeholder="Decimal Color">
            </div>
            <div class="modal-actions">
                <button id="modal-cancel">H·ªßy</button>
                <button id="modal-save" class="btn-primary">L∆∞u</button>
            </div>
        </div>
    </div>

    <script>
        const categoryContainer = document.getElementById('category-container');
        const saveBtn = document.getElementById('save-btn');
        const refreshBtn = document.getElementById('refresh-btn');
        const addCatBtn = document.getElementById('add-category-btn');
        const statusMsg = document.getElementById('status-msg');
        const loading = document.getElementById('loading');

        // Modal Elements
        const modal = document.getElementById('edit-modal');
        const editName = document.getElementById('edit-name');
        const editColorDecimal = document.getElementById('edit-color-decimal');
        const editColorPicker = document.getElementById('edit-color-picker');
        let currentEditingRoleId = null;

        // Fetch Data
        async function fetchRoles() {
            loading.style.display = 'block';
            categoryContainer.innerHTML = '';
            statusMsg.textContent = '';

            try {
                const res = await fetch('/api/roles');
                const categories = await res.json();

                if (categories.error) {
                    showStatus(categories.error, true);
                    return;
                }

                renderCategories(categories);
                loading.style.display = 'none';
            } catch (err) {
                showStatus('L·ªói k·∫øt n·ªëi: ' + err, true);
                loading.style.display = 'none';
            }
        }

        function renderCategories(categories) {
            categoryContainer.innerHTML = '';

            categories.forEach(cat => {
                const catDiv = document.createElement('div');
                catDiv.className = 'category-card';
                catDiv.dataset.id = cat.id;
                catDiv.dataset.isReal = cat.is_real_category;

                // Header
                const header = document.createElement('div');
                header.className = 'category-header';

                // Content of Header
                let headerContent = `
                    <div class="cat-title">
                        <span class="drag-handle">‚ò∞</span>
                        <button class="toggle-btn" data-cat-id="${cat.id}">‚ñº</button>
                        <span class="cat-name" style="color:${intToHex(cat.color)}">${cat.name}</span>
                    </div>
                    <div class="cat-actions">
                        ${cat.is_real_category ? `<button class="btn-icon edit-role-btn" data-id="${cat.id}" data-name="${cat.name}" data-color="${cat.color}">‚úèÔ∏è</button>` : ''}
                        <button class="btn-small add-role-btn" data-cat-id="${cat.id}">‚ûï Role</button>
                    </div>
                `;
                header.innerHTML = headerContent;
                catDiv.appendChild(header);

                // Role List (Sortable Area)
                const roleList = document.createElement('ul');
                roleList.className = 'role-list';
                roleList.dataset.catId = cat.id;

                cat.roles.forEach(role => {
                    const li = createRoleElement(role);
                    roleList.appendChild(li);
                });

                catDiv.appendChild(roleList);
                categoryContainer.appendChild(catDiv);

                // Make Roles Sortable
                new Sortable(roleList, {
                    group: 'roles', // Allow dragging between categories
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    onEnd: onDragEnd
                });
            });

            // Make Categories Sortable
            new Sortable(categoryContainer, {
                animation: 150,
                handle: '.drag-handle',
                ghostClass: 'sortable-ghost',
                onEnd: onDragEnd
            });

            // Attach Event Listeners for dynamic buttons
            attachDynamicEvents();
        }

        function createRoleElement(role) {
            const li = document.createElement('li');
            li.className = 'role-item';
            li.dataset.id = role.id;

            li.innerHTML = `
                <span class="role-color" style="background-color:${intToHex(role.color)}"></span>
                <span class="role-name">${role.name}</span>
                <button class="btn-icon edit-role-btn" data-id="${role.id}" data-name="${role.name}" data-color="${role.color}">‚úèÔ∏è</button>
            `;

            if (role.managed) {
                li.classList.add('managed');
                li.title = "Managed Role (Bot/Integration)";
            }
            return li;
        }

        function onDragEnd() {
            saveBtn.disabled = false;
            saveBtn.textContent = 'üíæ L∆∞u C·∫•u Tr√∫c (Ch∆∞a l∆∞u)';
            saveBtn.classList.add('btn-warning');
        }

        // --- EDIT LOGIC ---
        function attachDynamicEvents() {
            document.querySelectorAll('.edit-role-btn').forEach(btn => {
                btn.onclick = (e) => {
                    const { id, name, color } = e.target.dataset;
                    openEditModal(id, name, color);
                };
            });

            document.querySelectorAll('.add-role-btn').forEach(btn => {
                btn.onclick = (e) => {
                    // Quick add role logic
                    const name = prompt("Nh·∫≠p t√™n Role m·ªõi:");
                    if (name) createRole(name, false, e.target);
                };
            });

            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.onclick = (e) => {
                    const catId = e.target.dataset.catId;
                    const roleList = document.querySelector(`.role-list[data-cat-id="${catId}"]`);
                    if (roleList) {
                        const isCollapsed = roleList.classList.toggle('collapsed');
                        e.target.textContent = isCollapsed ? '‚ñ∂' : '‚ñº';
                    }
                };
            });
        }

        addCatBtn.onclick = () => {
            const name = prompt("Nh·∫≠p t√™n Ph√¢n M·ª•c m·ªõi:");
            if (name) createRole(name, true, null);
        };

        async function createRole(name, isCategory, targetBtn) {
            try {
                const res = await fetch('/api/roles/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, is_category: isCategory })
                });
                if (res.ok) {
                    showStatus('‚úÖ ƒê√£ t·∫°o role m·ªõi. ƒêang t·∫£i l·∫°i...', false);
                    fetchRoles();
                } else {
                    showStatus('‚ùå L·ªói t·∫°o role', true);
                }
            } catch (e) {
                showStatus('L·ªói: ' + e, true);
            }
        }

        // Helper: Int to Hex
        function intToHex(intColor) {
            if (!intColor) return '#99aab5';
            return '#' + intColor.toString(16).padStart(6, '0');
        }

        function hexToInt(hex) {
            return parseInt(hex.replace('#', ''), 16);
        }

        // --- SAVE LOGIC ---
        saveBtn.onclick = async () => {
            saveBtn.disabled = true;
            saveBtn.textContent = '‚è≥ ƒêang l∆∞u (Batch Update)...';
            showStatus('ƒêang g·ª≠i l·ªánh c·∫≠p nh·∫≠t l√™n Discord... vui l√≤ng ƒë·ª£i.', false);

            // Build structure
            const categories = [];

            // Iterate over Category Cards
            document.querySelectorAll('.category-card').forEach(card => {
                const catId = card.dataset.id;
                const isReal = card.dataset.isReal === 'true';
                const roleList = card.querySelector('.role-list');

                const roleIds = [];
                roleList.querySelectorAll('.role-item').forEach(li => {
                    roleIds.push(li.dataset.id);
                });

                categories.push({
                    id: catId,
                    is_real_category: isReal,
                    role_ids: roleIds
                });
            });

            try {
                const res = await fetch('/api/roles/reorder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ categories })
                });

                const data = await res.json();

                if (res.ok) {
                    showStatus('‚úÖ C·∫≠p nh·∫≠t th√†nh c√¥ng!', false);
                    saveBtn.textContent = 'üíæ L∆∞u C·∫•u Tr√∫c';
                    saveBtn.classList.remove('btn-warning');
                } else {
                    showStatus('‚ùå L·ªói: ' + data.error, true);
                    saveBtn.disabled = false;
                }
            } catch (err) {
                showStatus('‚ùå L·ªói m·∫°ng: ' + err, true);
                saveBtn.disabled = false;
            }
        };

        // --- MODAL LOGIC ---
        function openEditModal(id, name, color) {
            currentEditingRoleId = id;
            editName.value = name;
            editColorDecimal.value = color;
            editColorPicker.value = intToHex(Number(color));
            modal.style.display = 'block';
        }

        editColorPicker.oninput = (e) => {
            editColorDecimal.value = hexToInt(e.target.value);
        }

        editColorDecimal.oninput = (e) => {
            editColorPicker.value = intToHex(Number(e.target.value));
        }

        document.getElementById('modal-cancel').onclick = () => {
            modal.style.display = 'none';
        }

        document.getElementById('modal-save').onclick = async () => {
            if (!currentEditingRoleId) return;

            const newName = editName.value;
            const newColor = editColorDecimal.value;

            try {
                const res = await fetch(`/api/roles/update/${currentEditingRoleId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: newName, color: newColor })
                });

                if (res.ok) {
                    modal.style.display = 'none';
                    showStatus('‚úÖ ƒê√£ c·∫≠p nh·∫≠t th√¥ng tin role.', false);
                    fetchRoles(); // Refresh UI
                } else {
                    alert("L·ªói c·∫≠p nh·∫≠t role");
                }
            } catch (e) {
                alert("L·ªói k·∫øt n·ªëi");
            }
        }

        refreshBtn.onclick = fetchRoles;

        function showStatus(msg, isError) {
            statusMsg.textContent = msg;
            statusMsg.style.color = isError ? '#ff4444' : '#44ff44';
        }

        // Init
        fetchRoles();
    </script>
</body>

</html>